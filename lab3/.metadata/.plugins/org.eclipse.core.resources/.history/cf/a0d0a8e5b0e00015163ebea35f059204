
#include "basic_io.h"
#include "test.h"
#include "LCD.h"
#include "DM9000A.C"

unsigned int aaa,rx_len,i,packet_num;
unsigned char RXT[68];

void ethernet_interrupts()
{
    packet_num++;
    aaa=ReceivePacket (RXT,&rx_len);
    if(!aaa)
    {
      printf("\n\nReceive Packet Length = %d",rx_len);
      for(i=0;i<rx_len;i++)
      {
        if(i%8==0)
        printf("\n");
        printf("0x%2X,",RXT[i]);
      }
    }
    outport(SEG7_DISPLAY_BASE,packet_num);
}

int readSwitches()
{
    return inport(SWITCH_PIO_BASE);
}

void writeLEDs(int value)
{
    outport(LED_RED_BASE,value);
}

int main(void)
{
  unsigned char TXT[] = { 0x20, 0x20 };
  LCD_Test();
  //ether_addr = {0x01, 0x60, 0x6E, 0x11, 0x02, 0xFF }; // Set MAC address with our group id as the last byte
  DM9000_init();
  alt_irq_register( DM9000A_IRQ, NULL, (void*)ethernet_interrupts );
  
  packet_num=0;
  while (1)
  {
    int value = readSwitches();
    TXT[63] = value&0xFF;
    TransmitPacket(TXT, 2);
    
    msleep(500);
    
    ReceivePacket(RXT, &rx_len);
    int i;
    for (i = 0; i < rx_len; i++) {
        printf("%x ", RXT[i]);
    }
    printf("\n");
    writeLEDs(RXT[63]);
    msleep(500);
  }

  return 0;
}

//-------------------------------------------------------------------------


